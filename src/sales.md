---
theme: dashboard
toc: false
sql:
  txn1mm: ./data/cc_data_1mm.parquet
---
# Credit Card Transactions
This dashboard demonstrates how easy the Observable Framework makes it to use the superfast OLAP DuckDB-WASM running in browser.
Fake credit card transaction data (just over 1MM records) was generated by [Sparkov_Data_Generation](https://github.com/namebrandon/Sparkov_Data_Generation), and converted to Parquet format (only 35MB) at build time using DuckDB. The merchant filter modifies the SQL driving the count and the table.

```js
const merchants_csv = await FileAttachment("./data/merchants.csv").csv();
// display(merchants_csv)
const merchants = [null].concat(merchants_csv.map(item => item.merchant).sort());
// display(merchants)
```

```js
const selected_merchant = view(
  Inputs.select(merchants, {
    label: "Merchant",
  })
);
```

```sql id=filtered_transactions
SELECT * FROM txn1mm WHERE ${selected_merchant} IS NULL OR merchant=${selected_merchant}
```
```sql id=filtered_top_1000_rollup_by_amt
select count(*) as txn_count, sum(amt) txn_amt_sum, avg(amt) txn_amt_avg, merchant, lat, long
FROM txn1mm
WHERE ${selected_merchant} IS NULL OR merchant=${selected_merchant}
GROUP BY all
ORDER BY 2 desc
LIMIT 1000
```

```js
const amt_col = filtered_transactions.getChild('amt');
const sum = amt_col.toArray().reduce((acc, val) => acc + val, 0);
const avg = sum / filtered_transactions.numRows
```

```js
const us = await FileAttachment("./data/us-counties-10m.json").json()
const states = topojson.feature(us, us.objects.states)
function salesGeoBubble(data, {width} = {}) {
  return Plot.plot({
    projection: "albers-usa",
    marks: [
      Plot.geo(states),
      // Plot.geo(statemesh, {strokeOpacity: 0.2})
      Plot.dot(data, {
        x: "long",
        y: "lat",
        r: "txn_amt_sum",
        // fill: "PrimSource", // Update dot fill color to depend on primary source (variable: PrimSource)
        opacity: 0.7, // Decrease opacity (0 = transparent, 1 = opaque)
        tip: true
      })
    ]
  });
};
function salesGeoHexBin(data, {width} = {}) {
  return Plot.plot({
    projection: "albers-usa",
    marks: [
      Plot.geo(states),
      Plot.dot(
        data,
        Plot.hexbin(
          { r: "sum", fill: "sum" },
          { x: "long", y: "lat", fill:"txn_amt_sum" }
        )
      )
    ],
    height: 500,
    width: 800,
    margin: 50,
    r: { range: [0, 15] },
    color: {
      legend: true,
      label: "Sales",
      scheme: "cool"
    }
  });
};
```

<div class="grid grid-cols-4">
  <div class="card">
    <h2>Number of Transactions</h2>
    <span class="big">${filtered_transactions.numRows.toLocaleString("en-US")}</span>
  </div>
  <div class="card">
    <h2>Sum of Transaction Amounts</h2>
    <span class="big">${sum.toLocaleString("en-US")}</span>
  </div>
  <div class="card">
    <h2>Average of Transaction Amounts</h2>
    <span class="big">${avg.toFixed(2).toLocaleString("en-US")}</span>
  </div>
  <div class="card grid-rowspan-4 grid-colspan-2">
    <h2>Sales $ Volume by Location</h2>
    ${resize((width) => salesGeoBubble(filtered_top_1000_rollup_by_amt, {width}))}
  </div>
  <div class="card grid-rowspan-4 grid-colspan-2">
    <h2>Sales $ Volume by Location</h2>
    ${resize((width) => salesGeoHexBin(filtered_top_1000_rollup_by_amt, {width}))}
  </div>
</div>


```js
view(Inputs.table(filtered_top_1000_rollup_by_amt))
view(Inputs.table(filtered_transactions))
```