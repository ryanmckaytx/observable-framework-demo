---
theme: dashboard
toc: false
sql:
  txn1mm: ./data/cc_data_1mm.parquet
---
# Retail Sales
<details>
  <summary>Description</summary>

This dashboard demonstrates how easy the Observable Framework makes it to use the superfast OLAP DuckDB-WASM running in browser.
Fake credit card transaction data (just over 1MM records) was generated by [Sparkov_Data_Generation](https://github.com/namebrandon/Sparkov_Data_Generation), and converted to Parquet format (only 35MB) at build time using DuckDB. The store filter modifies the SQL driving the count and the table.

</details>

```js
// import {sparkline} from "./components/sparkline.js";
const merchants_csv = await FileAttachment("./data/merchants.csv").csv();
// display(merchants_csv)
const merchants = [null].concat(merchants_csv.map(item => item.merchant).sort());
// display(merchants)
```

```js
const selected_merchant = view(
  Inputs.select(merchants, {
    label: "Store",
  })
);
const start_date = view(
  Inputs.date({label: "Start", min: "2023-01-01", max: "2023-12-31", value: "2023-10-01"})
);
const end_date = view(
  Inputs.date({label: "End", min: "2023-01-01", max: "2023-12-31", value: "2023-12-31"})
);
```

```sql id=summarized_txn
summarize txn1mm 
```
```sql id=filtered_transactions
SELECT * FROM txn1mm 
WHERE 
  (${selected_merchant} IS NULL OR merchant=${selected_merchant})
  AND (${start_date} IS NULL OR trans_date >= ${start_date.toISOString().split('T')[0]})
  AND (${end_date} IS NULL OR trans_date <= ${end_date.toISOString().split('T')[0]})
ORDER BY trans_date ASC
```
```sql id=filtered_rollup_by_location
select count(*) as txn_count, sum(amt) txn_amt_sum, avg(amt) txn_amt_avg, merchant, merch_lat lat, merch_long long
FROM txn1mm
WHERE 
  (${selected_merchant} IS NULL OR merchant=${selected_merchant})
  AND (${start_date} IS NULL OR trans_date >= ${start_date.toISOString().split('T')[0]})
  AND (${end_date} IS NULL OR trans_date <= ${end_date.toISOString().split('T')[0]})
GROUP BY all
ORDER BY 2 desc
-- LIMIT 1000
```
```sql id=filtered_rollup_by_date
select count(*) as txn_count, sum(amt) txn_amt_sum, avg(amt) txn_amt_avg, trans_date
FROM txn1mm
WHERE 
  (${selected_merchant} IS NULL OR merchant=${selected_merchant})
  AND (${start_date} IS NULL OR trans_date >= ${start_date.toISOString().split('T')[0]})
  AND (${end_date} IS NULL OR trans_date <= ${end_date.toISOString().split('T')[0]})
GROUP BY all
ORDER BY trans_date ASC
-- LIMIT 1000
```
```js
function salesBars(data, {width} = {}) {
    return Plot.plot(
      {
        marks: [
          Plot.rectY(data, {
            x: "trans_date", 
            y: "txn_amt_sum", 
            interval: "day", 
            tip:true,
            fill: "steelblue",
          }),
          Plot.ruleY([0])
        ],
        width: width,
        marginBottom: 50,
      });
};
```

```js
const amt_col = filtered_transactions.getChild('amt');
const sum = amt_col.toArray().reduce((acc, val) => acc + val, 0);
const avg = sum / filtered_transactions.numRows
```

```js
const us = await FileAttachment("./data/us-counties-10m.json").json()
const states = topojson.feature(us, us.objects.states)
function salesGeoHexBin(data, {width} = {}) {
  return Plot.plot({
    projection: "albers-usa",
    marks: [
      Plot.geo(states),
      Plot.dot(
        data,
        Plot.hexbin(
          { r: "count", fill: "sum" },
          { x: "long", y: "lat", fill:"txn_amt_sum", tip: true }
        )
      )
    ],
    height: 500,
    width: 800,
    margin: 50,
    r: { range: [0, 15] },
    color: {
      legend: true,
      label: "Sales",
      scheme: "cool"
    }
  });
};
```

<div class="grid grid-cols-3">
  <div class="card">
    <h2>Number of Transactions</h2>
    <span class="big">${filtered_transactions.numRows.toLocaleString("en-US")}</span>
  </div>
  <div class="card">
    <h2>Sum of Transaction Amounts</h2>
    <span class="big">${sum.toLocaleString("en-US")}</span>
  </div>
  <div class="card">
    <h2>Average of Transaction Amounts</h2>
    <span class="big">${avg.toFixed(2).toLocaleString("en-US")}</span>
  </div>
</div>
<div class="grid grid-cols-2">
  <div class="card">
    <h2>Sales $ Volume over Time</h2>
    ${resize((width) => salesBars(filtered_rollup_by_date, {width}))}
  </div>
  <div class="card">
    <h2>Sales $ Volume by Location</h2>
    ${resize((width) => salesGeoHexBin(filtered_rollup_by_location, {width}))}
  </div>
</div>


<!-- ```js
view(Inputs.table(filtered_rollup_by_location))
view(Inputs.table(filtered_transactions))
view(Inputs.table(summarized_txn))
view(Inputs.table(filtered_rollup_by_date))
``` -->