---
theme: dashboard
toc: false
sql:
  txn1mm: ./data/cc_data_1mm.parquet
---
# Credit Card Transactions
This dashboard demonstrates how easy the Observable Framework makes it to use the superfast OLAP DuckDB-WASM running in browser.
Fake credit card transaction data (just over 1MM records) was generated by [Sparkov_Data_Generation](https://github.com/namebrandon/Sparkov_Data_Generation), and converted to Parquet format (only 35MB) at build time using DuckDB. The merchant filter modifies the SQL driving the count and the table.

```js
const merchants_csv = await FileAttachment("./data/merchants.csv").csv();
// display(merchants_csv)
const merchants = [null].concat(merchants_csv.map(item => item.merchant).sort());
// display(merchants)
```

```js
const selected_merchant = view(
  Inputs.select(merchants, {
    label: "Merchant",
  })
);
```

```sql id=filtered_transactions
SELECT * FROM txn1mm WHERE ${selected_merchant} IS NULL OR merchant=${selected_merchant}
```
```sql id=filtered_category_breakdown
SELECT category, COUNT(*) as count
FROM txn1mm WHERE ${selected_merchant} IS NULL OR merchant=${selected_merchant} 
GROUP BY category
```

```js
const amt_col = filtered_transactions.getChild('amt');
const sum = amt_col.toArray().reduce((acc, val) => acc + val, 0);
const avg = sum / filtered_transactions.numRows
```

```js
function categoryBreakdown(data, {width} = {}) {
  return Plot.plot({
    marginBottom: 80,
    x: {
      tickRotate: -30,
    },
    y: {
      transform: (d) => d / 1000,
      label: "â†‘ Number of Transactions (thousands)",
      grid: 5
    },
    marks: [
      Plot.ruleY([0]),
      Plot.barY(data, {
        x: "category",
        y: "count",
        sort: { x: "y", reverse: true, limit: 20 },
        fill: "steelblue"
      }),
    ]
  });
}
```

<div class="grid grid-cols-3">
  <div class="card">
    <h2>Number of Transactions</h2>
    <span class="big">${filtered_transactions.numRows.toLocaleString("en-US")}</span>
  </div>
  <div class="card">
    <h2>Sum of Transaction Amounts</h2>
    <span class="big">${sum.toLocaleString("en-US")}</span>
  </div>
  <div class="card">
    <h2>Average of Transaction Amounts</h2>
    <span class="big">${avg.toFixed(2).toLocaleString("en-US")}</span>
  </div>
  <div class="card grid-rowspan-4 grid-colspan-3">
    <h2>Category Breakdown</h2>
    ${resize((width) => categoryBreakdown(filtered_category_breakdown, {width}))}
  </div>
</div>


```js
view(Inputs.table(filtered_transactions))
```